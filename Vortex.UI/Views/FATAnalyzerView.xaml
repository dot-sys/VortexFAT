<Page x:Class="Vortex.UI.Views.FATAnalyzerView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:converters="clr-namespace:Vortex.UI.Converters"
  Title="{DynamicResource FATAnalyzer}"
  Background="Transparent">

<Page.Resources>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    <converters:ContainsDeletedConverter x:Key="ContainsDeletedConverter"/>
    <converters:RowForegroundConverter x:Key="RowForegroundConverter"/>
    <converters:ItemsCountConverter x:Key="ItemsCountConverter"/>
</Page.Resources>

<Border Background="#000000" CornerRadius="0,0,8,8">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Top Controls: Unmark Toggles -->
        <Border Grid.Row="0"
                Padding="8,6"
                Margin="0,0,0,10">
            <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Center">
                <ToggleButton Content="{DynamicResource UnmarkDeleted}" 
                              IsChecked="{Binding MarkDeletedRed, Mode=TwoWay}"
                              Cursor="Hand"
                              Margin="0,0,10,0"/>
                <ToggleButton Content="{DynamicResource UnmarkUnsigned}" 
                              IsChecked="{Binding MarkUnsignedGold, Mode=TwoWay}"
                              Cursor="Hand"
                              Margin="0,0,10,0"/>
                <ToggleButton Content="{DynamicResource UnmarkHidden}" 
                              IsChecked="{Binding MarkHiddenBlue, Mode=TwoWay}"
                              Cursor="Hand"/>
            </StackPanel>
        </Border>

        <!-- Main Content: TreeView (Left) and DataGrid (Right) -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Side: File/Folder TreeView -->
            <Border Grid.Column="0" 
                    BorderBrush="#333333" 
                    BorderThickness="1"
                    Background="#0a0a0a">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- TreeView Header -->
                    <Border Grid.Row="0" 
                            Background="#1A1A1A" 
                            BorderBrush="#333333" 
                            BorderThickness="0,0,0,1"
                            Padding="8,4">
                        <TextBlock Text="{DynamicResource EvidenceTree}" 
                                   Foreground="White"
                                   FontFamily="Consolas"
                                   FontWeight="Bold"/>
                    </Border>

                    <!-- TreeView -->
                    <TreeView Grid.Row="1"
                              x:Name="FileTreeView"
                              ItemsSource="{Binding FileTree}"
                              SelectedItemChanged="FolderTreeView_SelectedItemChanged"
                              MouseDoubleClick="FileTreeView_MouseDoubleClick"
                              Padding="4">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="FontFamily" Value="Consolas"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TreeViewItem">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition/>
                                                </Grid.RowDefinitions>
                                                <Border Name="Bd"
                                                        Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                        Padding="{TemplateBinding Padding}">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <ToggleButton x:Name="Expander"
                                                                      Grid.Column="0"
                                                                      IsChecked="{Binding Path=IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                                      ClickMode="Press"
                                                                      Background="Transparent"
                                                                      BorderThickness="0"
                                                                      Padding="0"
                                                                      Margin="0,0,4,0"
                                                                      Width="16"
                                                                      Height="16">
                                                            <ToggleButton.Template>
                                                                <ControlTemplate TargetType="ToggleButton">
                                                                    <Border Background="Transparent" Width="16" Height="16">
                                                                        <TextBlock x:Name="ExpanderText" 
                                                                                   Text="â–¶" 
                                                                                   Foreground="White" 
                                                                                   FontSize="8"
                                                                                   HorizontalAlignment="Center"
                                                                                   VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsChecked" Value="True">
                                                                            <Setter TargetName="ExpanderText" Property="Text" Value="â–¼"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </ToggleButton.Template>
                                                        </ToggleButton>
                                                        <ContentPresenter x:Name="PART_Header"
                                                                          Grid.Column="1"
                                                                          ContentSource="Header"
                                                                          HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"/>
                                                    </Grid>
                                                </Border>
                                                <ItemsPresenter x:Name="ItemsHost"
                                                                Grid.Row="1"
                                                                Margin="16,0,0,0"/>
                                            </Grid>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsExpanded" Value="False">
                                                    <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                                                </Trigger>
                                                <Trigger Property="HasItems" Value="False">
                                                    <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="Bd" Property="Background" Value="#1A1A1A"/>
                                                </Trigger>
                                                <Trigger SourceName="Bd" Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bd" Property="Background" Value="#252525"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TreeView.ItemContainerStyle>
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal" Margin="2">
                                    <!-- Icon based on node type -->
                                    <TextBlock Margin="0,0,4,0" VerticalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="ðŸ“„ "/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="0">
                                                        <!-- Drive -->
                                                        <Setter Property="Text" Value="ðŸ’¾ "/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="1">
                                                        <!-- Root -->
                                                        <Setter Property="Text" Value="ðŸ  "/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="2">
                                                        <!-- Folder -->
                                                        <Setter Property="Text" Value="ðŸ“ "/>
                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding NodeType}" Value="3">
                                                                        <!-- Unallocated -->
                                                                        <Setter Property="Text" Value="âš ï¸ "/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding NodeType}" Value="4">
                                                                        <!-- AllFiles -->
                                                                        <Setter Property="Text" Value="ðŸ“‹ "/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                    <!-- Name with color based on deleted status and node type -->
                                    <TextBlock VerticalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="{Binding DisplayName}"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="0">
                                                        <!-- Drive - Bold -->
                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="1">
                                                        <!-- Root - Bold -->
                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="3">
                                                        <!-- Unallocated - Gray and Italic -->
                                                        <Setter Property="Foreground" Value="#888888"/>
                                                        <Setter Property="FontStyle" Value="Italic"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding NodeType}" Value="4">
                                                        <!-- AllFiles - Gray and Italic -->
                                                        <Setter Property="Foreground" Value="#888888"/>
                                                        <Setter Property="FontStyle" Value="Italic"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                                        <Setter Property="Foreground" Value="#FF6B6B"/>
                                                        <Setter Property="FontStyle" Value="Italic"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        </TextBlock>
                                        <!-- Deleted indicator -->
                                        <TextBlock Text="{DynamicResource DeletedIndicator}" 
                                                   Foreground="#FF6B6B" 
                                                   FontSize="9"
                                                   VerticalAlignment="Center"
                                                   Margin="4,0,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Grid>
            </Border>

            <!-- Right Side: Files DataGrid -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="179"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                    <!-- DataGrid -->
                    <Border Grid.Row="0"
                            BorderBrush="#333333" 
                            BorderThickness="1">
                        <DataGrid x:Name="FilesDataGrid"
                                  Style="{StaticResource VortexDataGridStyle}"
                                  ItemsSource="{Binding FilteredFiles}"
                                  AutoGenerateColumns="False"
                                  SelectionChanged="FilesDataGrid_SelectionChanged"
                                  MouseDoubleClick="FilesDataGrid_MouseDoubleClick">
                              <DataGrid.RowStyle>
                                  <Style TargetType="DataGridRow">
                                      <Setter Property="FontFamily" Value="Consolas"/>
                                      <Setter Property="Background">
                                          <Setter.Value>
                                              <SolidColorBrush Color="#000000"/>
                                          </Setter.Value>
                                      </Setter>
                                      <Setter Property="Foreground">
                                          <Setter.Value>
                                              <MultiBinding Converter="{StaticResource RowForegroundConverter}">
                                                  <Binding Path="DataContext.MarkDeletedRed" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                  <Binding Path="Status"/>
                                                  <Binding Path="DataContext.MarkUnsignedGold" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                  <Binding Path="Signature"/>
                                                  <Binding Path="DataContext.MarkHiddenBlue" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                  <Binding Path="IsHidden"/>
                                              </MultiBinding>
                                          </Setter.Value>
                                      </Setter>
                                      <Style.Triggers>
                                          <Trigger Property="AlternationIndex" Value="1">
                                              <Setter Property="Background">
                                                  <Setter.Value>
                                                      <SolidColorBrush Color="#0a0a0a"/>
                                                  </Setter.Value>
                                              </Setter>
                                          </Trigger>
                                          <Trigger Property="IsMouseOver" Value="True">
                                              <Setter Property="Background">
                                                  <Setter.Value>
                                                      <SolidColorBrush Color="#252525"/>
                                                  </Setter.Value>
                                              </Setter>
                                          </Trigger>
                                          <Trigger Property="IsSelected" Value="True">
                                              <Setter Property="Background">
                                                  <Setter.Value>
                                                      <SolidColorBrush Color="#1A1A1A"/>
                                                  </Setter.Value>
                                              </Setter>
                                          </Trigger>
                                      </Style.Triggers>
                                  </Style>
                              </DataGrid.RowStyle>
                        <DataGrid.ContextMenu>
                            <ContextMenu Style="{StaticResource VortexDataGridContextMenuStyle}" Opened="ContextMenu_Opened">
                                <MenuItem x:Name="RecoverMenuItem" Header="{DynamicResource Recover}" Click="Recover_Click"/>
                                <MenuItem x:Name="RecoverAllMenuItem" Header="{DynamicResource RecoverAll}" Click="RecoverAll_Click"/>
                                <Separator x:Name="RecoverSeparator"/>
                                <MenuItem Header="{DynamicResource CopyValue}" Click="CopyValue_Click"/>
                                <MenuItem Header="{DynamicResource CopyRow}" Click="CopyRow_Click"/>
                                <MenuItem Header="{DynamicResource CopyAll}" Click="CopyAll_Click"/>
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Width="30">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="ðŸ“„"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                                            <Setter Property="Text" Value="ðŸ“"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="{DynamicResource Type}" Binding="{Binding Type}" Width="60"/>
                            <DataGridTextColumn Header="{DynamicResource Name}" Binding="{Binding DisplayName}" Width="*"/>
                            <DataGridTextColumn Header="{DynamicResource SizeKB}" Binding="{Binding FileSizeKB}" Width="120">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right"/>
                                        <Setter Property="Margin" Value="0,0,8,0"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="{DynamicResource LastActivity}" Binding="{Binding LastActivity}" Width="160"/>
                            <DataGridTextColumn Header="{DynamicResource Status}" Binding="{Binding Status}" Width="65"/>
                            <DataGridTextColumn Header="{DynamicResource Signature}" Binding="{Binding Signature}" Width="80"/>
                        </DataGrid.Columns>
                            </DataGrid>
                            </Border>

                                        <!-- Bottom DataGrid -->
                                        <Border Grid.Row="1"
                                                BorderBrush="#333333"
                                                BorderThickness="1"
                                                Margin="0,12,0,0">
                                            <DataGrid x:Name="BottomDataGrid"
                                                      Style="{StaticResource VortexDataGridStyle}"
                                                      ItemsSource="{Binding BottomGridData}"
                                                      RowBackground="#000000"
                                                      AlternatingRowBackground="#0a0a0a"
                                                      AutoGenerateColumns="False"
                                                      HeadersVisibility="None"
                                                      CanUserSortColumns="False"
                                                      IsReadOnly="True"
                                                      EnableRowVirtualization="False"
                                                      EnableColumnVirtualization="False">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn Binding="{Binding Column1, Mode=OneWay}" Width="150"/>
                                                        <DataGridTemplateColumn Width="*">
                                                            <DataGridTemplateColumn.CellTemplate>
                                                                <DataTemplate>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="{Binding Column2, Mode=OneWay}" 
                                                                                   VerticalAlignment="Center"/>
                                                                        <TextBlock VerticalAlignment="Center" Margin="5,0,0,0"
                                                                                   Visibility="{Binding Column3, Converter={StaticResource ContainsDeletedConverter}}">
                                                                            <Hyperlink NavigateUri="{Binding Column3, Mode=OneWay}" 
                                                                                       RequestNavigate="Hyperlink_RequestNavigate"
                                                                                       Foreground="#6495ED"
                                                                                       TextDecorations="None">
                                                                                <Run Text="(VirusTotal)"/>
                                                                            </Hyperlink>
                                                                        </TextBlock>
                                                                    </StackPanel>
                                                                </DataTemplate>
                                                            </DataGridTemplateColumn.CellTemplate>
                                                        </DataGridTemplateColumn>
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                            </Border>

                                                                                                         <!-- Item Count Display at Bottom Center -->
                                                                                                         <Border Grid.Row="2"
                                                                                                                 Background="#1A1A1A" 
                                                                                                                 BorderBrush="#333333" 
                                                                                                                 BorderThickness="1,0,1,1"
                                                                                                                 Padding="8,6">
                                                                                                            <TextBlock Text="{Binding FilteredFiles.Count, Converter={StaticResource ItemsCountConverter}}" 
                                                                                                                       Foreground="#888888"
                                                                                                                       FontFamily="Consolas"
                                                                                                                       HorizontalAlignment="Center"
                                                                                                                       VerticalAlignment="Center"/>
                                                                                                         </Border>
                                                                                                    </Grid>
                                                                                                </Grid>

                                                            <!-- Loading Overlay -->
                                                            <Grid Grid.RowSpan="2" 
                                                                  Background="#CC000000" 
                                                                  Visibility="{Binding IsLoadingOverlayVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                  IsHitTestVisible="{Binding IsLoadingOverlayVisible}">
                                                                <StackPanel HorizontalAlignment="Center" 
                                                                            VerticalAlignment="Center">
                                                                    <TextBlock Text="{Binding LoadingMessage}" 
                                                                               Foreground="White"
                                                                               FontSize="14"
                                                                               FontFamily="Consolas"
                                                                               HorizontalAlignment="Center"/>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Grid>
                                                    </Border>
                                                    </Page>
